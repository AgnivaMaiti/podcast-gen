<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudySauce - PDF to Podcast</title>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4F46E5;
            --bg: #F9FAFB;
            --card: #FFFFFF;
            --text: #111827;
            --text-light: #6B7280;
        }
        body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; background: var(--bg); color: var(--text); }
        .container { max-width: 800px; margin: 0 auto; padding: 2rem; }
        header { text-align: center; margin-bottom: 2rem; }
        h1 { color: var(--primary); margin-bottom: 0.5rem; }
        .card { background: var(--card); border-radius: 1rem; padding: 2rem; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .btn { 
            background: var(--primary); color: white; border: none; padding: 0.75rem 1.5rem; 
            border-radius: 0.5rem; cursor: pointer; font-weight: 500; display: inline-flex; align-items: center;
        }
        .btn svg { margin-right: 0.5rem; }
        .hidden { display: none; }
        #dropZone { 
            border: 2px dashed #E5E7EB; border-radius: 0.75rem; padding: 3rem 2rem; 
            text-align: center; cursor: pointer; margin: 1.5rem 0;
        }
        #dropZone:hover { border-color: var(--primary); }
        .progress-bar { height: 8px; background: #E5E7EB; border-radius: 4px; margin: 1.5rem 0; }
        .progress-fill { height: 100%; width: 0%; background: var(--primary); transition: width 0.3s; }
        .hosts-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 0.75rem; margin: 1rem 0; }
        .host-option { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; border: 1px solid #E5E7EB; border-radius: 0.5rem; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>StudySauce</h1>
            <p>Transform your study materials into engaging podcast episodes</p>
        </header>
        
        <div class="card">
            <h2>Upload Your PDF</h2>
            <div id="dropZone" onclick="document.getElementById('fileInput').click()">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="#4F46E5">
                    <path d="M19 13H13V19H11V13H5V11H11V5H13V11H19V13Z"/>
                </svg>
                <p>Click to select a PDF or drag and drop</p>
                <input type="file" id="fileInput" accept=".pdf" style="display:none" onchange="handleFileSelect(event)">
            </div>
            
            <div id="customizationPanel" class="hidden">
                <h3>Customize Your Podcast</h3>
                
                <div style="margin: 1.5rem 0;">
                    <label>Number of Hosts</label>
                    <input type="number" id="numHosts" min="1" max="4" value="2" onchange="updateHosts()" style="width: 100%; padding: 0.5rem; margin: 0.5rem 0;">
                </div>
                
                <div style="margin: 1.5rem 0;">
                    <label>Podcast Length: <span id="lengthValue">10</span> minutes</label>
                    <input type="range" id="podcastLength" min="3" max="15" value="10" oninput="updateLengthDisplay()" style="width: 100%;">
                </div>
                
                <div id="hostsContainer" class="hidden">
                    <label>Select Hosts:</label>
                    <div id="hostsList" class="hosts-grid"></div>
                </div>
                
                <button id="processBtn" class="btn" onclick="uploadFile()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                        <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM16 13H13V16H11V13H8V11H11V8H13V11H16V13Z"/>
                    </svg>
                    Generate Podcast
                </button>
            </div>
        </div>
        
        <div id="progressSection" class="card hidden">
            <h2>Creating Your Podcast</h2>
            <p id="statusText">Processing...</p>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div id="downloadSection" class="hidden">
                <p>Your podcast is ready!</p>
                <audio controls style="width: 100%; margin: 1rem 0;"></audio>
                <button class="btn" onclick="downloadPodcast()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                        <path d="M19 9H15V3H9V9H5L12 16L19 9ZM5 18V20H19V18H5Z"/>
                    </svg>
                    Download Podcast
                </button>
            </div>
        </div>
    </div>

    <script>
        // Your existing JavaScript code here
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                document.getElementById('customizationPanel').classList.remove('hidden');
            }
        }
        
        function updateLengthDisplay() {
            const length = document.getElementById('podcastLength').value;
            document.getElementById('lengthValue').textContent = length;
        }
        
        const availableHosts = [
            { id: 'alex', name: 'Alex', voice: 'EXAVITQu4vr4xnSDxMaL' },
            { id: 'sarah', name: 'Sarah', voice: 'EXAVITQu4vr4xnSDxMaL' },
            { id: 'david', name: 'David', voice: 'CYw3kZ02Hs0563khs1Fj' },
            { id: 'emma', name: 'Emma', voice: 'MF3mGyEYCl7XYWbV9V6O' },
            { id: 'ryan', name: 'Ryan', voice: 'wViXBPUzp2ZZixB1xQuM' },
            { id: 'lisa', name: 'Lisa', voice: 'Xp3qGTXRZ6gafkFgVcNy' }
        ];

        function updateHosts() {
            const numHosts = parseInt(document.getElementById('numHosts').value);
            const hostsList = document.getElementById('hostsList');
            hostsList.innerHTML = '';
            
            // Create host selection checkboxes
            availableHosts.slice(0, numHosts).forEach((host, index) => {
                const hostDiv = document.createElement('div');
                hostDiv.className = 'host-option';
                hostDiv.innerHTML = `
                    <input type="checkbox" id="host-${host.id}" name="selectedHosts" value="${host.id}" 
                           data-voice="${host.voice}" ${index < 2 ? 'checked' : ''}>
                    <label for="host-${host.id}">${host.name}</label>
                `;
                hostsList.appendChild(hostDiv);
            });
            
            document.getElementById('hostsContainer').classList.remove('hidden');
        }
        
        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a PDF file first');
                return;
            }
            
            const formData = new FormData();
            formData.append('pdf', file);
            
            // Get selected hosts
            const selectedHosts = [];
            document.querySelectorAll('input[name="selectedHosts"]:checked').forEach(checkbox => {
                selectedHosts.push({
                    id: checkbox.value,
                    voice: checkbox.dataset.voice,
                    name: checkbox.nextElementSibling.textContent
                });
            });
            
            // Add podcast settings
            formData.append('num_hosts', document.getElementById('numHosts').value);
            formData.append('podcast_length', document.getElementById('podcastLength').value);
            formData.append('selected_hosts', JSON.stringify(selectedHosts));
            
            // Show progress section
            document.getElementById('progressSection').classList.remove('hidden');
            document.getElementById('customizationPanel').classList.add('hidden');
            
            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('Upload failed');
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Start polling for status
                pollStatus(data.task_id);
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('statusText').textContent = 'Error: ' + error.message;
            }
        }
        
        // Initialize FFmpeg
        const { createFFmpeg, fetchFile } = FFmpeg;
        const ffmpeg = createFFmpeg({ log: true });
        let isFFmpegLoaded = false;
        
        async function loadFFmpeg() {
            if (!isFFmpegLoaded) {
                document.getElementById('statusText').textContent = 'Loading audio tools...';
                await ffmpeg.load();
                isFFmpegLoaded = true;
            }
        }
        
        async function convertWavToMp3(wavData) {
            try {
                await loadFFmpeg();
                const inputName = 'input.wav';
                const outputName = 'output.mp3';
                
                // Write the WAV file to FFmpeg's virtual filesystem
                ffmpeg.FS('writeFile', inputName, await fetchFile(new Blob([wavData], { type: 'audio/wav' })));
                
                // Run FFmpeg command to convert WAV to MP3
                await ffmpeg.run('-i', inputName, '-codec:a', 'libmp3lame', '-qscale:a', '2', outputName);
                
                // Read the result
                const data = ffmpeg.FS('readFile', outputName);
                
                // Clean up
                ffmpeg.FS('unlink', inputName);
                ffmpeg.FS('unlink', outputName);
                
                return new Blob([data.buffer], { type: 'audio/mp3' });
            } catch (error) {
                console.error('Error converting audio:', error);
                throw error;
            }
        }
        
        // Start loading FFmpeg in the background
        loadFFmpeg().catch(console.error);

        async function pollStatus(taskId) {
            try {
                console.log(`Polling status for task: ${taskId}`);
                const response = await fetch(`/status/${taskId}`);
                
                // Log raw response for debugging
                console.log('Response status:', response.status, response.statusText);
                
                if (!response.ok) {
                    let errorText = await response.text();
                    console.error('Error response:', errorText);
                    
                    if (response.status === 404) {
                        throw new Error('Session expired. Please refresh the page and try again.');
                    }
                    throw new Error(`Server returned ${response.status}: ${response.statusText} - ${errorText}`);
                }
                
                const data = await response.json();
                console.log('Status data:', JSON.stringify(data, null, 2));
                
                // Update progress
                const progress = data.progress || 0;
                document.getElementById('progressFill').style.width = `${progress}%`;
                document.getElementById('statusText').textContent = data.status || 'Processing...';
                
                if (progress >= 100 && data.download_url) {
                    // Show download section when complete
                    document.getElementById('downloadSection').classList.remove('hidden');
                    const audioPlayer = document.querySelector('#downloadSection audio');
                    audioPlayer.src = data.download_url;
                    
                    // Update download button to use the actual file URL
                    const downloadBtn = document.querySelector('#downloadSection button');
                    downloadBtn.onclick = () => {
                        window.location.href = data.download_url;
                    };
                    
                    return; // Stop polling
                }
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Continue polling every 2 seconds
                setTimeout(() => pollStatus(taskId), 2000);
                
            } catch (error) {
                console.error('Error polling status:', error);
                const statusElement = document.getElementById('statusText');
                if (statusElement) {
                    let errorMessage = error.message || 'Failed to check status';
                    
                    // Special handling for FFmpeg errors
                    if (errorMessage.includes('FFmpeg') || errorMessage.includes('ffmpeg')) {
                        errorMessage = 'FFmpeg is required for audio processing. Please install FFmpeg and restart the application.';
                    }
                    
                    statusElement.textContent = 'Error: ' + errorMessage;
                    statusElement.style.color = '#ef4444'; // Red color for error
                }
                
                // Show retry button
                const retryButton = document.createElement('button');
                retryButton.className = 'btn';
                retryButton.style.marginTop = '1rem';
                retryButton.innerHTML = 'Retry';
                retryButton.onclick = () => {
                    window.location.reload();
                };
                
                const progressSection = document.getElementById('progressSection');
                if (progressSection) {
                    progressSection.appendChild(retryButton);
                }
            }
        }
        
        function downloadPodcast() {
            const audioPlayer = document.querySelector('#downloadSection audio');
            if (audioPlayer && audioPlayer.src) {
                const a = document.createElement('a');
                a.href = audioPlayer.src;
                a.download = 'podcast.mp3';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }
        }
    </script>
</body>
</html>
